# Architecture: Set up Turborepo monorepo with TanStack Start, Expo, and Convex packages

## Clarification Questions

No clarification questions at this time. All requirements are sufficiently detailed.

---

## System Overview

NutriCodex is a nutrition/food tracking application delivered as a monorepo containing a web app (TanStack Start), a mobile app (Expo), and a shared backend (Convex). The monorepo is orchestrated by Turborepo with Bun as the package manager and runtime.

```
                         +-------------------+
                         |   Turborepo Root  |
                         |  (orchestration)  |
                         +--------+----------+
                                  |
                +--+--------------+---------------+--+
                |                 |                   |
        +-------v------+  +------v-------+  +--------v----------+
        |  apps/web    |  | apps/mobile  |  | packages/backend  |
        | TanStack     |  | Expo +       |  | Convex +          |
        | Start +      |  | Expo Router  |  | Better Auth       |
        | Tailwind v4  |  | + Uniwind    |  | (shared)          |
        | + ShadCN UI  |  | + RN         |  +--------+----------+
        +------+-------+  | Reusables    |           ^
               |           +------+-------+           |
               |                  |                   |
               +--------+---------+-------------------+
                        |
              +---------v-----------+
              | packages/           |
              | typescript-config   |
              | (shared tsconfigs)  |
              +---------------------+
```

Both apps import the typed Convex API and client utilities from `@nutricodex/backend`. TypeScript configurations are shared via `@nutricodex/typescript-config`. Biome provides unified linting and formatting from the root.

---

## Directory Structure

```
NutriCodex/
|-- .github/
|   `-- workflows/
|       `-- ci.yml                          # GitHub Actions CI workflow
|-- apps/
|   |-- mobile/
|   |   |-- app/
|   |   |   |-- _layout.tsx                 # Root layout (Convex + auth providers)
|   |   |   `-- index.tsx                   # Home screen placeholder
|   |   |-- src/
|   |   |   |-- lib/
|   |   |   |   `-- auth-client.ts          # Better Auth client (Expo)
|   |   |   `-- global.css                  # Uniwind global CSS
|   |   |-- app.json                        # Expo app configuration
|   |   |-- babel.config.js                 # Babel config (required by Expo)
|   |   |-- metro.config.js                 # Metro bundler config with Uniwind
|   |   |-- package.json                    # @nutricodex/mobile
|   |   `-- tsconfig.json                   # Extends typescript-config/react-native.json
|   `-- web/
|       |-- src/
|       |   |-- components/
|       |   |   `-- ui/                     # ShadCN UI components directory (empty)
|       |   |-- lib/
|       |   |   |-- auth-client.ts          # Better Auth client (web)
|       |   |   |-- auth-server.ts          # Server-side auth helpers (TanStack Start)
|       |   |   `-- utils.ts                # cn() utility for ShadCN
|       |   |-- routes/
|       |   |   |-- api/
|       |   |   |   `-- auth/
|       |   |   |       `-- $.ts            # Auth API route handler (proxy to Convex)
|       |   |   |-- __root.tsx              # Root layout (providers, HTML doc)
|       |   |   `-- index.tsx               # Index route placeholder
|       |   |-- router.tsx                  # Router creation with ConvexQueryClient
|       |   `-- styles/
|       |       `-- globals.css             # Tailwind CSS v4 directives + theme vars
|       |-- components.json                 # ShadCN UI configuration
|       |-- package.json                    # @nutricodex/web
|       |-- tsconfig.json                   # Extends typescript-config/react.json
|       `-- vite.config.ts                  # Vite config with TanStack Start + Tailwind
|-- packages/
|   |-- backend/
|   |   |-- convex/
|   |   |   |-- _generated/                # Auto-generated by `convex dev` (gitignored)
|   |   |   |-- auth.config.ts             # Better Auth provider config
|   |   |   |-- auth.ts                    # Better Auth instance + Convex adapter
|   |   |   |-- convex.config.ts           # Registers Better Auth component
|   |   |   |-- http.ts                    # HTTP route handler for Better Auth
|   |   |   `-- schema.ts                  # Schema (Better Auth tables only)
|   |   |-- src/
|   |   |   `-- index.ts                   # Package entry: re-exports client utilities + typed API
|   |   |-- package.json                   # @nutricodex/backend
|   |   `-- tsconfig.json                  # Extends typescript-config/base.json
|   `-- typescript-config/
|       |-- base.json                       # Shared base: strict, ES2022, Bundler resolution
|       |-- react.json                      # Extends base: JSX, web-specific settings
|       |-- react-native.json              # Extends base: RN/Metro-compatible settings
|       `-- package.json                   # @nutricodex/typescript-config
|-- .env.example                            # Environment variable documentation
|-- .gitignore                              # Comprehensive gitignore
|-- biome.json                              # Root Biome configuration
|-- bun.lock                                # Generated by bun install
|-- package.json                            # Root: workspaces, scripts, devDependencies
`-- turbo.json                              # Turborepo task configuration
```

---

## Component Design

### 1. Root Monorepo (`/`)

- **Responsibility**: Orchestrates all workspace packages via Turborepo. Houses shared tooling configuration (Biome, TypeScript base, git).
- **Interface**: Root `package.json` scripts (`dev`, `dev:web`, `dev:mobile`, `dev:backend`, `build`, `lint`, `type-check`, `format`).
- **Dependencies**: `turbo` (devDep), `@biomejs/biome` (devDep), `typescript` (devDep).
- **Location**: Repository root `/`.

### 2. TanStack Start Web App (`apps/web`)

- **Responsibility**: SSR web application with file-based routing. Hosts the web auth flow and provides the primary web interface.
- **Interface**: Vite dev server on port 3000; produces a Node.js server bundle for production.
- **Dependencies**: `@tanstack/react-start`, `@tanstack/react-router`, `@tanstack/react-query`, `@convex-dev/react-query`, `@tanstack/react-router-with-query`, `react`, `react-dom`, `convex`, `@convex-dev/better-auth`, `better-auth@1.4.9`, `tailwindcss`, `@tailwindcss/vite`, `@nutricodex/backend` (workspace), `vite-tsconfig-paths`, `@vitejs/plugin-react`, `clsx`, `tailwind-merge`, `class-variance-authority`.
- **Location**: `apps/web/`.

### 3. Expo Mobile App (`apps/mobile`)

- **Responsibility**: Cross-platform mobile application (iOS/Android) running in Expo Go. Uses Expo Router for file-based routing.
- **Interface**: Metro dev server; runs in Expo Go via QR code.
- **Dependencies**: `expo`, `expo-router`, `expo-secure-store`, `react-native`, `react`, `convex`, `@convex-dev/better-auth`, `better-auth@1.4.9`, `@better-auth/expo@1.4.9`, `uniwind`, `tailwindcss`, `react-native-reanimated`, `react-native-safe-area-context`, `@rn-primitives/portal`, `@nutricodex/backend` (workspace).
- **Location**: `apps/mobile/`.

### 4. Convex Backend Package (`packages/backend`)

- **Responsibility**: Shared backend containing the Convex schema, functions, and Better Auth integration. Both apps consume this package for typed API access.
- **Interface**: Exports Convex client utilities (`ConvexProvider`, `ConvexReactClient`), typed API (`api` from `_generated/api`), `ConvexBetterAuthProvider`, and auth component helpers.
- **Dependencies**: `convex`, `@convex-dev/better-auth`, `better-auth@1.4.9`.
- **Location**: `packages/backend/`.

### 5. TypeScript Config Package (`packages/typescript-config`)

- **Responsibility**: Houses shared TypeScript compiler configurations extended by all workspaces.
- **Interface**: Three JSON config files: `base.json`, `react.json`, `react-native.json`.
- **Dependencies**: None (config-only package).
- **Location**: `packages/typescript-config/`.

---

## Dependency Graph

```
@nutricodex/web ----depends-on----> @nutricodex/backend
                `---depends-on----> @nutricodex/typescript-config

@nutricodex/mobile --depends-on---> @nutricodex/backend
                   `-depends-on---> @nutricodex/typescript-config

@nutricodex/backend -depends-on---> @nutricodex/typescript-config
```

All workspace dependencies use the `workspace:*` protocol in their respective `package.json` files.

---

## Data Model

This scaffolding task produces an empty Convex schema. The only tables present are those automatically managed by the Better Auth component (user, session, account, verification). These tables are managed by the `@convex-dev/better-auth` component and cannot be altered directly.

```typescript
// packages/backend/convex/schema.ts
import { defineSchema } from "convex/server";

const schema = defineSchema({
  // Application tables will be added here in future tasks.
  // Better Auth tables (user, session, account, verification)
  // are managed by the Better Auth component and do not appear here.
});

export default schema;
```

---

## API Design

### Convex HTTP Routes (packages/backend/convex/http.ts)

Better Auth routes are mounted on the Convex HTTP router. These handle sign-up, sign-in, sign-out, session management, and token exchange.

```typescript
// packages/backend/convex/http.ts
import { httpRouter } from "convex/server";
import { authComponent, createAuth } from "./auth";

const http = httpRouter();
authComponent.registerRoutes(http, createAuth);

export default http;
```

### Web Auth API Proxy (apps/web/src/routes/api/auth/$.ts)

The TanStack Start web app proxies auth requests from the client to Convex via a catch-all API route.

```typescript
// apps/web/src/routes/api/auth/$.ts
import { createAPIFileRoute } from "@tanstack/react-start/api";
import { handler } from "~/lib/auth-server";

export const APIRoute = createAPIFileRoute("/api/auth/$")({
  GET: ({ request }) => handler(request),
  POST: ({ request }) => handler(request),
});
```

---

## Package Configurations

### Root `package.json`

```jsonc
{
  "name": "nutricodex",
  "private": true,
  "workspaces": ["apps/*", "packages/*"],
  "scripts": {
    "dev": "turbo run dev",
    "dev:web": "turbo run dev --filter=@nutricodex/web",
    "dev:mobile": "turbo run dev --filter=@nutricodex/mobile",
    "dev:backend": "turbo run dev --filter=@nutricodex/backend",
    "build": "turbo run build",
    "lint": "turbo run lint",
    "type-check": "turbo run type-check",
    "format": "turbo run format"
  },
  "devDependencies": {
    "@biomejs/biome": "^2.3.14",
    "turbo": "^2.8.3",
    "typescript": "^5.7.0"
  },
  "packageManager": "bun@1.2.4"
}
```

### Root `turbo.json`

```jsonc
{
  "$schema": "https://turborepo.dev/schema.json",
  "ui": "tui",
  "globalDependencies": [".env"],
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": [".output/**", "dist/**"]
    },
    "dev": {
      "dependsOn": ["^build"],
      "persistent": true,
      "cache": false
    },
    "lint": {
      "dependsOn": ["^build"]
    },
    "type-check": {
      "dependsOn": ["^build"]
    },
    "format": {
      "cache": false
    }
  }
}
```

### Root `biome.json`

```jsonc
{
  "$schema": "https://biomejs.dev/schemas/2.3.14/schema.json",
  "vcs": {
    "enabled": true,
    "clientKind": "git",
    "useIgnoreFile": true
  },
  "files": {
    "ignore": [
      "node_modules",
      ".turbo",
      "dist",
      ".output",
      ".convex",
      ".expo",
      "convex/_generated"
    ]
  },
  "formatter": {
    "enabled": true,
    "indentStyle": "space",
    "indentWidth": 2,
    "lineWidth": 100,
    "lineEnding": "lf"
  },
  "linter": {
    "enabled": true,
    "rules": {
      "recommended": true
    }
  },
  "assist": {
    "enabled": true,
    "actions": {
      "source": {
        "recommended": true
      }
    }
  },
  "javascript": {
    "formatter": {
      "quoteStyle": "double",
      "semicolons": "always",
      "trailingCommas": "all"
    }
  },
  "json": {
    "formatter": {
      "enabled": true
    }
  }
}
```

### Root `tsconfig.json`

Note: The root `tsconfig.json` is intentionally minimal. It references the shared base config for editor tooling. Actual build/check configs are per-workspace.

```jsonc
{
  "extends": "./packages/typescript-config/base.json",
  "compilerOptions": {
    "composite": false,
    "declaration": false
  },
  "exclude": ["node_modules", "apps", "packages"]
}
```

### `packages/typescript-config/base.json`

```jsonc
{
  "compilerOptions": {
    "strict": true,
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "Bundler",
    "jsx": "react-jsx",
    "skipLibCheck": true,
    "esModuleInterop": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "forceConsistentCasingInFileNames": true
  }
}
```

### `packages/typescript-config/react.json`

```jsonc
{
  "extends": "./base.json",
  "compilerOptions": {
    "lib": ["DOM", "DOM.Iterable", "ES2022"],
    "jsx": "react-jsx",
    "noEmit": true
  }
}
```

### `packages/typescript-config/react-native.json`

```jsonc
{
  "extends": "./base.json",
  "compilerOptions": {
    "lib": ["ES2022"],
    "jsx": "react-jsx",
    "noEmit": true,
    "types": ["react-native"]
  }
}
```

### `packages/typescript-config/package.json`

```jsonc
{
  "name": "@nutricodex/typescript-config",
  "version": "0.0.0",
  "private": true,
  "files": ["base.json", "react.json", "react-native.json"]
}
```

### `packages/backend/package.json`

```jsonc
{
  "name": "@nutricodex/backend",
  "version": "0.0.0",
  "private": true,
  "type": "module",
  "main": "./src/index.ts",
  "types": "./src/index.ts",
  "exports": {
    ".": {
      "types": "./src/index.ts",
      "import": "./src/index.ts"
    },
    "./convex/*": {
      "types": "./convex/*",
      "import": "./convex/*"
    }
  },
  "scripts": {
    "dev": "convex dev",
    "build": "echo 'No build step for backend package'",
    "lint": "biome check .",
    "type-check": "tsc --noEmit"
  },
  "dependencies": {
    "convex": "^1.31.5",
    "@convex-dev/better-auth": "^0.10.10",
    "better-auth": "1.4.9"
  },
  "devDependencies": {
    "@nutricodex/typescript-config": "workspace:*",
    "typescript": "^5.7.0"
  }
}
```

### `packages/backend/tsconfig.json`

```jsonc
{
  "extends": "@nutricodex/typescript-config/base.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": ".",
    "noEmit": true
  },
  "include": ["src/**/*", "convex/**/*"],
  "exclude": ["node_modules", "dist", "convex/_generated"]
}
```

### `apps/web/package.json`

```jsonc
{
  "name": "@nutricodex/web",
  "version": "0.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite dev",
    "build": "vite build",
    "serve": "vite preview",
    "lint": "biome check .",
    "type-check": "tsc --noEmit"
  },
  "dependencies": {
    "@nutricodex/backend": "workspace:*",
    "@convex-dev/better-auth": "^0.10.10",
    "@convex-dev/react-query": "^0.0.14",
    "@tanstack/react-query": "^5.66.0",
    "@tanstack/react-router": "^1.151.6",
    "@tanstack/react-router-with-query": "^1.151.6",
    "@tanstack/react-start": "^1.149.4",
    "better-auth": "1.4.9",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "convex": "^1.31.5",
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "tailwind-merge": "^3.0.0"
  },
  "devDependencies": {
    "@nutricodex/typescript-config": "workspace:*",
    "@tailwindcss/vite": "^4.1.18",
    "@types/react": "^19.0.0",
    "@types/react-dom": "^19.0.0",
    "@vitejs/plugin-react": "^4.3.0",
    "tailwindcss": "^4.1.18",
    "typescript": "^5.7.0",
    "vite": "^6.1.0",
    "vite-tsconfig-paths": "^5.1.0"
  }
}
```

### `apps/web/vite.config.ts`

```typescript
import { defineConfig } from "vite";
import tsConfigPaths from "vite-tsconfig-paths";
import { tanstackStart } from "@tanstack/react-start/plugin/vite";
import react from "@vitejs/plugin-react";
import tailwindcss from "@tailwindcss/vite";

export default defineConfig({
  server: {
    port: 3000,
  },
  plugins: [
    tsConfigPaths({
      projects: ["./tsconfig.json"],
    }),
    tanstackStart(),
    // React's Vite plugin must come after TanStack Start's plugin
    react(),
    tailwindcss(),
  ],
  ssr: {
    noExternal: ["@convex-dev/better-auth"],
  },
});
```

### `apps/web/tsconfig.json`

```jsonc
{
  "extends": "@nutricodex/typescript-config/react.json",
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"],
      "~/*": ["./src/*"]
    },
    "noEmit": true
  },
  "include": ["src/**/*", "vite.config.ts"],
  "exclude": ["node_modules"]
}
```

### `apps/web/components.json` (ShadCN UI)

```jsonc
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": false,
  "tsx": true,
  "tailwind": {
    "config": "",
    "css": "src/styles/globals.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "utils": "@/lib/utils",
    "hooks": "@/hooks"
  }
}
```

### `apps/mobile/package.json`

```jsonc
{
  "name": "@nutricodex/mobile",
  "version": "0.0.0",
  "private": true,
  "main": "expo-router/entry",
  "scripts": {
    "start": "expo start",
    "dev": "expo start",
    "android": "expo start --android",
    "ios": "expo start --ios",
    "lint": "biome check .",
    "type-check": "tsc --noEmit"
  },
  "dependencies": {
    "@nutricodex/backend": "workspace:*",
    "@convex-dev/better-auth": "^0.10.10",
    "@better-auth/expo": "1.4.9",
    "@rn-primitives/portal": "^1.1.0",
    "better-auth": "1.4.9",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "convex": "^1.31.5",
    "expo": "~54.0.0",
    "expo-router": "~4.0.0",
    "expo-secure-store": "~14.0.0",
    "expo-status-bar": "~2.0.0",
    "react": "^19.0.0",
    "react-native": "~0.77.0",
    "react-native-reanimated": "~3.17.0",
    "react-native-safe-area-context": "~5.4.0",
    "react-native-screens": "~4.7.0",
    "tailwind-merge": "^3.0.0",
    "tailwindcss": "^4.1.18",
    "uniwind": "^1.2.2"
  },
  "devDependencies": {
    "@nutricodex/typescript-config": "workspace:*",
    "@types/react": "^19.0.0",
    "typescript": "^5.7.0"
  }
}
```

### `apps/mobile/app.json`

```jsonc
{
  "expo": {
    "name": "NutriCodex",
    "slug": "nutricodex",
    "version": "0.0.1",
    "orientation": "portrait",
    "scheme": "nutricodex",
    "platforms": ["ios", "android"],
    "ios": {
      "supportsTablet": true,
      "bundleIdentifier": "com.nutricodex.app"
    },
    "android": {
      "package": "com.nutricodex.app"
    },
    "plugins": ["expo-router", "expo-secure-store"]
  }
}
```

### `apps/mobile/metro.config.js`

```javascript
const { getDefaultConfig } = require("expo/metro-config");
const { withUniwindConfig } = require("uniwind/metro");

const config = getDefaultConfig(__dirname);

module.exports = withUniwindConfig(config, {
  cssEntryFile: "./src/global.css",
  dtsFile: "./src/uniwind-types.d.ts",
});
```

### `apps/mobile/tsconfig.json`

```jsonc
{
  "extends": "@nutricodex/typescript-config/react-native.json",
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["./*"]
    },
    "noEmit": true
  },
  "include": ["**/*.ts", "**/*.tsx", ".expo/types/**/*.ts", "expo-env.d.ts"],
  "exclude": ["node_modules"]
}
```

---

## Authentication Flow

### Convex Backend (packages/backend)

#### 1. Component Registration (`convex/convex.config.ts`)

```typescript
import { defineApp } from "convex/server";
import betterAuth from "@convex-dev/better-auth/convex.config";

const app = defineApp();
app.use(betterAuth);

export default app;
```

#### 2. Auth Provider Config (`convex/auth.config.ts`)

```typescript
import { getAuthConfigProvider } from "@convex-dev/better-auth/auth-config";
import type { AuthConfig } from "convex/server";

export default {
  providers: [getAuthConfigProvider()],
} satisfies AuthConfig;
```

#### 3. Better Auth Instance (`convex/auth.ts`)

```typescript
import { createClient, type GenericCtx } from "@convex-dev/better-auth";
import { convex } from "@convex-dev/better-auth/plugins";
import { betterAuth } from "better-auth/minimal";
import authConfig from "./auth.config";
import { components } from "./_generated/api";
import type { DataModel } from "./_generated/dataModel";

const siteUrl = process.env.SITE_URL!;

export const authComponent = createClient<DataModel>(components.betterAuth);

export const createAuth = (ctx: GenericCtx<DataModel>) => {
  return betterAuth({
    baseURL: siteUrl,
    database: authComponent.adapter(ctx),
    emailAndPassword: {
      enabled: true,
      requireEmailVerification: false,
    },
    plugins: [convex({ authConfig })],
  });
};
```

#### 4. HTTP Routes (`convex/http.ts`)

```typescript
import { httpRouter } from "convex/server";
import { authComponent, createAuth } from "./auth";

const http = httpRouter();
authComponent.registerRoutes(http, createAuth);

export default http;
```

### Web App Auth (apps/web)

#### Client (`src/lib/auth-client.ts`)

```typescript
import { createAuthClient } from "better-auth/react";
import { convexClient } from "@convex-dev/better-auth/client/plugins";

export const authClient = createAuthClient({
  plugins: [convexClient()],
});
```

#### Server (`src/lib/auth-server.ts`)

```typescript
import { convexBetterAuthReactStart } from "@convex-dev/better-auth/react-start";

export const { handler, getToken, fetchAuthQuery, fetchAuthMutation, fetchAuthAction } =
  convexBetterAuthReactStart({
    convexUrl: process.env.VITE_CONVEX_URL!,
    convexSiteUrl: process.env.VITE_CONVEX_SITE_URL!,
  });
```

#### API Route (`src/routes/api/auth/$.ts`)

```typescript
import { createAPIFileRoute } from "@tanstack/react-start/api";
import { handler } from "~/lib/auth-server";

export const APIRoute = createAPIFileRoute("/api/auth/$")({
  GET: ({ request }) => handler(request),
  POST: ({ request }) => handler(request),
});
```

### Mobile App Auth (apps/mobile -- Placeholder)

The mobile app includes a placeholder auth client structure. Full auth integration requires expo-secure-store and the Better Auth Expo plugin.

#### Client (`src/lib/auth-client.ts`)

```typescript
import { createAuthClient } from "better-auth/react";
import { expoClient } from "@better-auth/expo/client";
import { convexClient } from "@convex-dev/better-auth/client/plugins";
import * as SecureStore from "expo-secure-store";
import Constants from "expo-constants";

export const authClient = createAuthClient({
  baseURL: process.env.EXPO_PUBLIC_CONVEX_SITE_URL,
  plugins: [
    expoClient({
      scheme: Constants.expoConfig?.scheme as string,
      storagePrefix: Constants.expoConfig?.scheme as string,
      storage: SecureStore,
    }),
    convexClient(),
  ],
});
```

---

## Router and Provider Setup

### Web App Router (`apps/web/src/router.tsx`)

```typescript
import { QueryClient } from "@tanstack/react-query";
import { createRouter as createTanStackRouter } from "@tanstack/react-router";
import { routerWithQueryClient } from "@tanstack/react-router-with-query";
import { ConvexQueryClient } from "@convex-dev/react-query";
import { ConvexProvider } from "convex/react";
import { routeTree } from "./routeTree.gen";

export function createRouter() {
  const convexUrl = import.meta.env.VITE_CONVEX_URL!;

  const convexQueryClient = new ConvexQueryClient(convexUrl);
  const queryClient = new QueryClient({
    defaultOptions: {
      queries: {
        queryKeyHashFn: convexQueryClient.hashFn(),
        queryFn: convexQueryClient.queryFn(),
      },
    },
  });
  convexQueryClient.connect(queryClient);

  const router = routerWithQueryClient(
    createTanStackRouter({
      routeTree,
      context: { queryClient },
      Wrap: ({ children }) => (
        <ConvexProvider client={convexQueryClient.convexClient}>
          {children}
        </ConvexProvider>
      ),
    }),
    queryClient,
  );

  return router;
}

declare module "@tanstack/react-router" {
  interface Register {
    router: ReturnType<typeof createRouter>;
  }
}
```

### Web App Root Layout (`apps/web/src/routes/__root.tsx`)

```typescript
import { Outlet, HeadContent, Scripts, createRootRouteWithContext } from "@tanstack/react-router";
import type { QueryClient } from "@tanstack/react-query";

export const Route = createRootRouteWithContext<{
  queryClient: QueryClient;
}>()({
  component: RootComponent,
  head: () => ({
    meta: [
      { charSet: "utf-8" },
      { name: "viewport", content: "width=device-width, initial-scale=1" },
      { title: "NutriCodex" },
    ],
    links: [
      { rel: "stylesheet", href: "/src/styles/globals.css" },
    ],
  }),
});

function RootComponent() {
  return (
    <html lang="en">
      <head>
        <HeadContent />
      </head>
      <body>
        <Outlet />
        <Scripts />
      </body>
    </html>
  );
}
```

### Mobile App Root Layout (`apps/mobile/app/_layout.tsx`)

```typescript
import { Slot } from "expo-router";
import { ConvexProvider, ConvexReactClient } from "convex/react";
import { PortalHost } from "@rn-primitives/portal";
import "../src/global.css";

const convex = new ConvexReactClient(process.env.EXPO_PUBLIC_CONVEX_URL!);

export default function RootLayout() {
  return (
    <ConvexProvider client={convex}>
      <Slot />
      <PortalHost />
    </ConvexProvider>
  );
}
```

---

## Build Pipeline

### Turborepo Task Graph

```
                  build
                    |
            dependsOn: ^build
                    |
    +-------+-------+-------+
    |       |       |       |
  web    mobile  backend  ts-config
 build    (no    (no       (no
          build)  build)    build)

                  dev
                    |
            (persistent, no cache)
                    |
    +-------+-------+-------+
    |       |               |
  web    mobile          backend
  vite   expo            convex
  dev    start           dev

                  lint
                    |
            dependsOn: ^build
                    |
    +-------+-------+-------+
    |       |       |       |
  web    mobile  backend  ts-config
 biome   biome   biome     (skip)
 check   check   check

              type-check
                    |
            dependsOn: ^build
                    |
    +-------+-------+-------+
    |       |       |       |
  web    mobile  backend  ts-config
  tsc    tsc     tsc       (skip)
```

### Dev Server Orchestration

Running `bun run dev` starts all three dev processes in parallel via Turborepo:

1. **Web** (`apps/web`): `vite dev` -- TanStack Start on port 3000
2. **Mobile** (`apps/mobile`): `expo start` -- Metro bundler on port 8081
3. **Backend** (`packages/backend`): `convex dev` -- Convex watcher connecting to cloud

Turborepo's TUI mode (`"ui": "tui"`) provides an interactive terminal for switching between process logs.

### CI Pipeline (`.github/workflows/ci.yml`)

```yaml
name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Lint
        run: bun run lint

      - name: Type check
        run: bun run type-check

      - name: Build
        run: bun run build
```

---

## Technology Decisions

### 1. Tailwind CSS v4 via Vite Plugin (not PostCSS)

**Rationale**: Tailwind CSS v4 introduces the `@tailwindcss/vite` plugin which integrates directly into the Vite build pipeline. Since TanStack Start is built on Vite, this provides the tightest integration with zero PostCSS configuration needed. Full builds are up to 5x faster and incremental builds are over 100x faster compared to v3. The `tailwind.config.js` file is eliminated entirely -- configuration happens in CSS.

### 2. Shared TypeScript Config Package

**Rationale**: The `packages/typescript-config` package prevents compiler option duplication across 4+ workspace `tsconfig.json` files. It provides three presets (`base`, `react`, `react-native`) that each workspace extends with minimal overrides. This is a well-established Turborepo pattern that ensures consistency.

### 3. Convex as a Workspace Package (not app-level)

**Rationale**: Placing Convex in `packages/backend` rather than in an individual app provides three benefits:
- Both web and mobile apps share the same typed API generated by Convex.
- The Convex schema and functions are defined once and consumed everywhere.
- The `convex dev` process runs independently of any app's dev server.

Apps import from `@nutricodex/backend` for Convex utilities and the typed API, ensuring type safety across the entire stack.

### 4. Biome over ESLint/Prettier

**Rationale**: Biome v2 provides linting, formatting, and import organization in a single tool written in Rust. It eliminates the need for separate ESLint + Prettier configurations, resolves the perennial ESLint/Prettier conflict issue, and runs significantly faster. A single `biome.json` at the root configures the entire monorepo.

### 5. Bun as Package Manager and Runtime

**Rationale**: Bun provides faster dependency installation, workspace support, and can run TypeScript directly. The `bun --bun vite dev` pattern uses Bun's runtime for Vite, though the Expo Metro bundler still uses Node.js internally.

### 6. ConvexQueryClient with TanStack Query

**Rationale**: Using `@convex-dev/react-query` bridges Convex's real-time subscriptions with TanStack Query's caching and SSR capabilities. This enables server-side rendering of Convex data in TanStack Start and consistent query timestamps during SSR, which is critical for hydration correctness.

### 7. Uniwind over NativeWind

**Rationale**: Uniwind (from the creators of Unistyles) provides Tailwind CSS v4 bindings for React Native with 2.5x better performance than NativeWind. It uses a custom high-performance CSS parser that understands Tailwind v4 syntax. React Native Reusables has official Uniwind support since December 2025.

### 8. Better Auth Pinned to 1.4.9

**Rationale**: The `@convex-dev/better-auth` component requires `better-auth@1.4.9` as a specific pinned dependency. This is a constraint imposed by the Convex Better Auth component's compatibility requirements and is documented in its official setup guide.

---

## Environment Variables

### Root `.env.example`

```bash
# Convex
CONVEX_DEPLOYMENT=dev:your-deployment-name
VITE_CONVEX_URL=https://your-deployment.convex.cloud
VITE_CONVEX_SITE_URL=https://your-deployment.convex.site

# Expo (same Convex values, different prefix for Expo bundler)
EXPO_PUBLIC_CONVEX_URL=https://your-deployment.convex.cloud
EXPO_PUBLIC_CONVEX_SITE_URL=https://your-deployment.convex.site

# Better Auth
BETTER_AUTH_SECRET=  # Generate via: openssl rand -base64 32

# Web App
SITE_URL=http://localhost:3000
```

Note: `VITE_` prefixed variables are exposed to the TanStack Start client bundle. `EXPO_PUBLIC_` prefixed variables are exposed to Expo. Non-prefixed variables are server-only.

---

## Root `.gitignore`

```
# Dependencies
node_modules/

# Turborepo
.turbo/

# Build outputs
dist/
.output/
.vinxi/

# Convex generated
.convex/
convex/_generated/

# Expo
.expo/

# Environment
.env
.env.local
.env.*.local

# OS
.DS_Store
Thumbs.db

# IDE
.vscode/
.idea/
*.swp
*.swo

# Bun
bun.lock
```

Note: `bun.lock` is included in `.gitignore` above for reference, but many teams choose to commit it. The developer should decide based on their preference. If committed, remove it from `.gitignore`.

---

## Key Source Files

### `packages/backend/src/index.ts`

```typescript
// Re-export Convex client utilities for apps
export { ConvexProvider, ConvexReactClient, useQuery, useMutation, useAction } from "convex/react";
export { ConvexBetterAuthProvider } from "@convex-dev/better-auth/react";

// Re-export typed API (available after `convex dev` generates types)
// Apps should import: import { api } from "@nutricodex/backend"
export { api } from "../convex/_generated/api";
export type { DataModel, Doc, Id } from "../convex/_generated/dataModel";
```

### `packages/backend/convex/schema.ts`

```typescript
import { defineSchema } from "convex/server";

// Better Auth tables (user, session, account, verification) are managed
// by the Better Auth component and do not need to be defined here.
// Application tables will be added in future tasks.
const schema = defineSchema({});

export default schema;
```

### `apps/web/src/routes/index.tsx`

```typescript
import { createFileRoute } from "@tanstack/react-router";

export const Route = createFileRoute("/")({
  component: IndexPage,
});

function IndexPage() {
  return (
    <div className="flex min-h-screen items-center justify-center">
      <h1 className="text-4xl font-bold">NutriCodex</h1>
    </div>
  );
}
```

### `apps/web/src/styles/globals.css`

```css
@import "tailwindcss";

@theme {
  --color-background: oklch(1 0 0);
  --color-foreground: oklch(0.145 0 0);
  --color-card: oklch(1 0 0);
  --color-card-foreground: oklch(0.145 0 0);
  --color-popover: oklch(1 0 0);
  --color-popover-foreground: oklch(0.145 0 0);
  --color-primary: oklch(0.205 0 0);
  --color-primary-foreground: oklch(0.985 0 0);
  --color-secondary: oklch(0.97 0 0);
  --color-secondary-foreground: oklch(0.205 0 0);
  --color-muted: oklch(0.97 0 0);
  --color-muted-foreground: oklch(0.556 0 0);
  --color-accent: oklch(0.97 0 0);
  --color-accent-foreground: oklch(0.205 0 0);
  --color-destructive: oklch(0.577 0.245 27.325);
  --color-destructive-foreground: oklch(0.577 0.245 27.325);
  --color-border: oklch(0.922 0 0);
  --color-input: oklch(0.922 0 0);
  --color-ring: oklch(0.708 0 0);
  --radius-sm: 0.25rem;
  --radius-md: 0.375rem;
  --radius-lg: 0.5rem;
  --radius-xl: 0.75rem;
}
```

### `apps/web/src/lib/utils.ts`

```typescript
import { type ClassValue, clsx } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
```

### `apps/mobile/src/global.css`

```css
@import "tailwindcss";
@import "uniwind";
```

### `apps/mobile/app/index.tsx`

```typescript
import { View, Text } from "react-native";

export default function HomeScreen() {
  return (
    <View style={{ flex: 1, alignItems: "center", justifyContent: "center" }}>
      <Text style={{ fontSize: 24, fontWeight: "bold" }}>NutriCodex</Text>
    </View>
  );
}
```

---

## Risk Assessment

### HIGH RISK

1. **Bun + Expo Metro Bundler Compatibility**
   - **Risk**: Metro bundler may not resolve transitive dependencies correctly when using Bun, because Bun stores dependencies in `node_modules/.bun/` rather than hoisting them conventionally. There are open GitHub issues documenting this (oven-sh/bun#25870). Additionally, HMR issues have been reported with Bun monorepos and Expo SDK 54 (expo/expo#42689).
   - **Mitigation**: Test Metro resolution early. If issues arise, consider running `bun install --yarn` to force a more conventional `node_modules` layout, or fall back to using `npx expo start` instead of `bun run start` for the mobile app. Keep Bun for dependency installation but use Node.js for Metro.

2. **Better Auth Version Pinning (1.4.9)**
   - **Risk**: `better-auth` is pinned to exactly `1.4.9` as required by `@convex-dev/better-auth`. This prevents security updates and new features until the Convex component is updated. If other dependencies have minimum version requirements for `better-auth` that conflict, resolution will fail.
   - **Mitigation**: Monitor the `@convex-dev/better-auth` repository for version bumps. Use the exact version (`1.4.9`, not `^1.4.9`) to prevent accidental upgrades.

### MEDIUM RISK

3. **TanStack Start Maturity**
   - **Risk**: TanStack Start is relatively young compared to Next.js. While it has reached v1.x, the API surface is still evolving (the shift from Vinxi to pure Vite plugin happened recently). The `createAPIFileRoute` API for the auth proxy route and `@tanstack/react-start/plugin/vite` import path may change between minor versions.
   - **Mitigation**: Pin TanStack Start dependencies to specific minor versions. Follow the TanStack Discord and changelog. The framework is actively maintained by the TanStack team.

4. **Convex Type Generation in Monorepo**
   - **Risk**: The `convex/_generated/` directory is created by `convex dev` and must exist before `tsc --noEmit` can pass on any file importing from the typed API. In CI, the generated files will not exist unless `convex dev` or `convex codegen` is run first.
   - **Mitigation**: Add a `codegen` script to `packages/backend` that runs `convex codegen` (generates types without starting the dev server). Make the `type-check` task depend on codegen, or exclude `_generated/` imports from type checking in CI until a Convex project is initialized.

5. **Uniwind Ecosystem Maturity**
   - **Risk**: Uniwind reached stable (v1.0) recently and is at v1.2.x. The React Native Reusables Uniwind support was added December 2025. The ecosystem is newer than NativeWind and may have edge cases or missing features.
   - **Mitigation**: React Native Reusables has official CLI support for Uniwind (`-t minimal-uniwind`). Test component rendering early when components are added in later tasks.

### LOW RISK

6. **Biome v2 Configuration Differences**
   - **Risk**: Biome v2 changed the import organizer from a top-level `organizeImports` field to an `assist.actions.source` configuration. Documentation and community examples may reference the v1 API.
   - **Mitigation**: Use the v2 schema (`$schema` field) and validate configuration with `bunx biome check`.

7. **Tailwind CSS v4 in CSS (no config file)**
   - **Risk**: Tailwind v4 eliminates `tailwind.config.js` in favor of CSS-based configuration (`@theme` directives). ShadCN UI's `components.json` expects a `tailwind.config` path, which should be left blank for v4.
   - **Mitigation**: Set `tailwind.config: ""` in `components.json`. ShadCN UI has been updated to support Tailwind v4 configuration.

8. **Environment Variable Prefixing**
   - **Risk**: Vite exposes `VITE_` prefixed variables. Expo exposes `EXPO_PUBLIC_` prefixed variables. Convex uses `CONVEX_URL` without prefix. This means the same Convex URL must be set multiple times with different prefixes.
   - **Mitigation**: Document all required variables clearly in `.env.example`. Consider a shared env setup script for future tasks.
